{% extends "AppTienda/base.html" %}
{% block title %}Dashboard | POS{% endblock %}

{% block content %}
<div class="container">
  {% if messages %}{% for m in messages %}<div class="alert alert-{{ m.tags }} py-2">{{ m }}</div>{% endfor %}{% endif %}

  <div class="row g-3 mb-3">
    <div class="col-md-4">
      <div class="card p-3">
        <div class="text-muted small mb-1">Top Sell (últimos 30 días)</div>
        <div class="h5 mb-1">{{ kpi.top_sell.name }}</div>
        <div>Ventas: <strong>{{ kpi.top_sell.qty }}</strong></div>
        <div>Precio: <strong>${{ kpi.top_sell.price }}</strong></div>
        <div>Ingresos: <strong>${{ kpi.top_sell.revenue }}</strong></div>
      </div>
    </div>
    <div class="col-md-8">
      <div class="card p-3">
        <div class="d-flex justify-content-between">
          <div class="text-muted small">Ingresos últimos 30 días</div>
          <div class="text-muted small">Total: <strong>${{ kpi.revenue }}</strong></div>
        </div>
        <!-- Fijamos una altura para que no “crezca” -->
        <div style="height:300px;">
          <canvas id="salesChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="card p-3">
    <div class="row g-3">
      <div class="col-md-4"><div class="border rounded p-3 h-100"><div class="text-muted small">Pedidos</div><div class="display-6">{{ kpi.orders|default:0 }}</div></div></div>
      <div class="col-md-4"><div class="border rounded p-3 h-100"><div class="text-muted small">Clientes</div><div class="display-6">{{ kpi.customers|default:0 }}</div></div></div>
      <div class="col-md-4"><div class="border rounded p-3 h-100"><div class="text-muted small">Ingresos</div><div class="display-6">${{ kpi.revenue|default:0 }}</div></div></div>
    </div>
  </div>
</div>

{{ labels|json_script:"labels-data" }}
{{ sales|json_script:"sales-data" }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(function(){
  const labels = JSON.parse(document.getElementById("labels-data").textContent || "[]");
  const sales  = JSON.parse(document.getElementById("sales-data").textContent || "[]");
  const ctx = document.getElementById('salesChart').getContext('2d');
  new Chart(ctx, {
    type:'line',
    data:{labels, datasets:[{label:'Ingresos', data:sales, fill:false, tension:0.25}]},
    options:{
      responsive:true,
      maintainAspectRatio:false,      // respeta el contenedor de 300px
      plugins:{legend:{display:false}},
      scales:{y:{beginAtZero:true}}
    }
  });
})();
</script>
{% endblock %}
