{% extends "AppTienda/base.html" %}
{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="container" style="max-width: 760px;">
  <h4 class="mb-3">{{ title }}</h4>

  <form method="post" novalidate>
    {% csrf_token %}
    {% if messages %}{% for m in messages %}<div class="alert alert-{{ m.tags }} py-2">{{ m }}</div>{% endfor %}{% endif %}
    {{ form.non_field_errors }}

    <div class="mb-3">
      <label class="form-label">Producto</label>
      {{ form.product }}
      {{ form.product.errors }}
    </div>

    <div class="mb-3">
      <label class="form-label">Cliente</label>
      {{ form.customer }}
      {{ form.customer.errors }}
    </div>

    <div class="mb-3">
      <label class="form-label">Cantidad</label>
      {{ form.quantity }}
      {{ form.quantity.errors }}
    </div>

    <div class="border rounded p-3 mb-3">
      <div class="d-flex justify-content-between">
        <div>Precio unitario:</div>
        <div><strong>$<span id="unitPrice">0.00</span></strong></div>
      </div>
      <div class="d-flex justify-content-between">
        <div>Total:</div>
        <div><strong>$<span id="totalPrice">0.00</span></strong></div>
      </div>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Guardar</button>
      <a class="btn btn-outline-secondary" href="{% url 'sales_list' %}">Cancelar</a>
    </div>
  </form>
</div>

{{ price_map|json_script:"price-map" }}
<script>
(function(){
  const priceMap = JSON.parse(document.getElementById("price-map").textContent || "{}");
  const $product = document.getElementById("id_product");
  const $qty = document.getElementById("id_quantity");
  const $unit = document.getElementById("unitPrice");
  const $total = document.getElementById("totalPrice");

  function recalc(){
    const pid = $product ? $product.value : null;
    const price = pid && priceMap[pid] ? parseFloat(priceMap[pid]) : 0.0;
    const qty = parseInt(($qty && $qty.value) ? $qty.value : 0, 10);
    $unit.textContent = price.toFixed(2);
    $total.textContent = (price * (isNaN(qty) ? 0 : qty)).toFixed(2);
  }

  if ($product) $product.addEventListener("change", recalc);
  if ($qty) $qty.addEventListener("input", recalc);
  recalc(); // calcular al cargar
})();
</script>
{% endblock %}
